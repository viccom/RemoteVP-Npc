# Vnet 虚拟网络用户手册

---------------------

## 功能描述

基于网络的远程编程是将远程的设备和安装了编程软件的电脑连接到一个虚拟交换机中，
让安装了编程软件的电脑如同本地连接设备一样。而且在设备端无需做任何配置，也无需保证设备是否能联网，
只要按照在现场的FreeIOE网关能和现场设备通讯同时可以连接互联网即可。
而在电脑端，也只需要安装搭建虚拟网络或虚拟串口的软件同时可以连接互联网即可。

通过基于网络的远程编程，你可以体验到如下功能：

1. 如同在本地局域网连接现场设备一样的体验（注：由于上网网速的影响，可能交互速度稍慢）

2. 和现场设备的连接完全是按需连接，需要时开启，不需要时关闭。

3. 整个过程全程加密压缩，既省流量，又安全可靠。

4. 除了设备的远程编程，其他需求（如连接远程电脑，访问远程服务等）亦可满足。


## 整体构成

现场的网关和编程软件所在电脑因为大多数情况下都位于内网环境中，并无互联网上的IP地址，因此是双方是无法直接连接的。因此我们在互联网上搭建了一系列的远程编程服务节点将现场的网关和编程软件电脑连接到一起。

由于现场的网关和编程软件电脑都能访问到远程编程服务节点，因此双方带着特殊标识信息连接到响应速度最快的远程编程服务节点时，服务节点会为双方建立一个加密压缩的专用通道，让网关中的虚拟网络软件和编程软件电脑中的虚拟网络软件能通讯构建一个专用的虚拟交换机或虚拟路由器。
整个架构示意图如下：


![系统架构](static/imgs/system-topo.png)


##  准备工作

1. 在PC电脑上安装本软件。

2. 有一台内置了 [FreeIOE](https://freeioe.org) 软件的网关

3. 在互联网上部署了 [NPS](https://github.com/ehang-io/nps) 软件，并开启NPS对外提供的服务端口。

## 部署 NPS 服务

* 从GitHub下载 [NPS](https://github.com/ehang-io/nps)  最新版，按照官方教程进行安装。也可通过配置好的压缩包 [NPSX64](https://thingscloud.oss-cn-beijing.aliyuncs.com/download/nps/nps.zip) 解压并安装。

* 将配置好的压缩包中的配置文件 conf/nps.conf 覆盖目标文件夹中的同名文件，按照要求，修改nps.conf文件中的auth_key和auth_crypt_key。修改后需重新编译生成二进制发布包。

* 在部署 NPS 服务的云服务器开放nps配置文件中定义的端口 bridge_port (访问端口) 和 web_port （API端口），以及端口范围 allow_ports （可用的端口映射范围）。

## 网关连接到冬笋云

* 注册用户

* 绑定网关到用户

* 生成Access-Key

以上步骤可参考冬笋云平台的 [用户帮助](http://help.cloud.thingsroot.com/guide/quick_start) 。


## 虚拟网络页面操作说明

虚拟网络操作页面提供的示例功能如下图所示：

![系统架构](static/imgs/vnet-page1.png)

页面主视图从上到下提供如下信息：

* 用户网关列表，授权文本框中填入用户的AccessKey后，可点击网关列表。

* 当前选中网关信息及所需依赖检查。

* 所需信息的输入框，包含：NPS API URL地址； NPS用户； 远程设备IP地址； 用户AccessKey。

* 本地服务反馈的后台信息。

* API执行反馈和后台周期广播的状态信息。


## 虚拟网络带宽测试

Vnet支持测试本机和网关之间的网络带宽，由于测试网络带宽会消耗网络流量，因此在进行此测试时请合理选择测试数据量大小。

Vnet API接口支持测试数据的大小为【1MB ~ 1024MB】，本示例页面提供【1MB ~ 50MB】。测试方向分为上行（本机→网关）和下行（网关→本机）。

Vnet后台测试的最长时间为30秒，如测试30秒还未完成，将不会获得测试结果。遇到这种情况，您需要减少测试的数据大小。


